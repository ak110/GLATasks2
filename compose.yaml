---
services:
  web:
    image: nginx
    restart: always
    volumes:
      - ./web/nginx.conf:/etc/nginx/conf.d/default.conf:ro
      - ./web/ssl:/etc/nginx/ssl:ro
      - ./web/static:/var/www/static:ro
    environment:
      - TZ=Asia/Tokyo
    networks:
      - network
    ports:
      - "38180:443"
    depends_on:
      - app
    logging:
      options:
        max-size: "1m"
        max-file: "3"

  db:
    image: mariadb:lts
    restart: always
    volumes:
      - ${DATA_DIR}/mariadb:/var/lib/mysql
      - ${PWD}/db/my.cnf:/etc/mysql/conf.d/my.cnf:ro
    environment:
      - TZ=Asia/Tokyo
      - MARIADB_USER=glatasks
      - MARIADB_PASSWORD=glatasks
      - MARIADB_DATABASE=glatasks
      - MARIADB_ROOT_PASSWORD=glatasks
      - MARIADB_AUTO_UPGRADE=1
    healthcheck:
      test: mariadb-admin ping --password=glatasks | grep 'is alive'
      start_period: 30s
      start_interval: 1s
    networks:
      - network
    logging:
      options:
        max-size: "1m"
        max-file: "3"

  migrate:
    profiles:
      - production
      - staging
    image: ghcr.io/ak110/glatasks2:latest
    restart: "no"
    environment:
      - DATABASE_URL=mysql://glatasks:glatasks@db/glatasks
    networks:
      - network
    depends_on:
      db:
        condition: service_healthy
    command: >
      node --input-type=module --eval "
        import { drizzle } from 'drizzle-orm/mysql2';
        import { migrate } from 'drizzle-orm/mysql2/migrator';
        import mysql from 'mysql2/promise';
        const conn = await mysql.createConnection(process.env.DATABASE_URL);
        const db = drizzle(conn);
        console.log('ðŸ”„ Running migrations from ./drizzle/migrations...');
        await migrate(db, { migrationsFolder: './drizzle/migrations' });
        await conn.end();
        console.log('âœ… Migrations completed successfully!');
      "

  migrate-dev:
    profiles:
      - development
    image: node:lts
    restart: "no"
    user: ${UID}:${GID}
    environment:
      - HOME=${PWD}/.cache
      - COREPACK_ENABLE_DOWNLOAD_PROMPT=0
      - DATABASE_URL=mysql://glatasks:glatasks@db/glatasks
    volumes:
      - ${PWD}:${PWD}
    working_dir: ${PWD}
    networks:
      - network
    depends_on:
      db:
        condition: service_healthy
    command: >
      bash -xc '
        mkdir -p ${PWD}/.cache/bin &&
        corepack enable --install-directory ${PWD}/.cache/bin &&
        export PATH=${PWD}/.cache/bin:$$PATH &&
        CI=true pnpm install &&
        node --input-type=module --eval "
          import { drizzle } from '\''drizzle-orm/mysql2'\'';
          import { migrate } from '\''drizzle-orm/mysql2/migrator'\'';
          import mysql from '\''mysql2/promise'\'';
          const conn = await mysql.createConnection(process.env.DATABASE_URL);
          const db = drizzle(conn);
          console.log('\''ðŸ”„ Running migrations from ./drizzle/migrations...'\'');
          await migrate(db, { migrationsFolder: '\''./drizzle/migrations'\'' });
          await conn.end();
          console.log('\''âœ… Migrations completed successfully!'\'');
        "
      '

include:
  - ./compose.${COMPOSE_PROFILE}.yaml

networks:
  network:
