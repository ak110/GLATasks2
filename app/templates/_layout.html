<!doctype html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
    <title>{% block title %}{% endblock %}</title>
    <link rel="shortcut icon" href="{{ url_for('static', filename='img/favicon-32.png') }}" type="image/png" />
    <link rel="icon" href="{{ url_for('static', filename='img/favicon-32.png') }}" type="image/png" />
    <link rel="stylesheet" href="{{ helpers.static_url_for(filename='dist/main.css') }}" />
    <meta name="mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-title" content="GLATasks" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black" />
    <link rel="manifest" href="{{ url_for('static', filename='manifest.webmanifest') }}" />
    <script type="module" src="{{ helpers.static_url_for(filename='dist/main.mjs') }}"></script>
    <script type="module" nonce="{{ g.script_nonce }}">
      globalThis.appConfig = {
        urls: {
          "lists.api": "{{ url_for('lists.api', show_type='__SHOW_TYPE__') }}".replace("/__SHOW_TYPE__", "/:show_type:"),
          "lists.api_tasks": "{{ url_for('lists.api_tasks', list_id=-999) }}".replace("/-999/", "/:list_id:/"),
          "tasks.patch_api": "{{ url_for('tasks.patch_api', list_id=-999, task_id=-999) }}"
            .replace("/-999/", "/:list_id:/")
            .replace("/-999", "/:task_id:"),
          _swjs: "{{ url_for('_swjs') }}",
        },
        encrypt_key: "{{ helpers.base64encode(helpers.encrypt_key) }}",
      }
      await globalThis.initializeApp()
    </script>
    {% block head %}{% endblock %}
  </head>

  <body
    x-data="{ loadingCount: 0 }"
    x-init='
      $watch("loadingCount", (value) => {
        const dialog = document.getElementById("loadingDialog")
        if (value > 0) {
          dialog.showModal()
        } else {
          dialog.close()
        }
      })
    '
  >
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
      <a class="navbar-brand ml-2" href="{{ url_for('main.index') }}">GLATasks</a>
      <div class="navbar-collapse collapse"></div>
      <ul class="navbar-nav">
        <li class="onlyPWA nav-item">
          <button class="btn btn-outline-success" onclick="globalThis.close();">&times;</button>
        </li>
      </ul>
    </nav>

    <div class="container">
      {% with messages = get_flashed_messages(with_categories=true) %}{%
        if
        messages
      %}
        {% for category, message in messages %}
          <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
          </div>
        {% endfor %}
      {% endif %}{% endwith %}
      {% block body %}
      {% endblock %}

      {% block foot %}
      {% endblock %}
    </div>

    {# ローディングダイアログ（全ページ共通） #}
    <dialog
      id="loadingDialog"
      class="fixed inset-0 m-0 h-screen max-h-none w-screen max-w-none border-none bg-transparent p-0 outline-none backdrop:bg-transparent"
    >
      <div class="flex h-full w-full items-center justify-center">
        <div class="h-48 w-48 animate-spin rounded-full border-8 border-blue-500 border-r-transparent" role="status">
          <span class="visually-hidden">Loading...</span>
        </div>
      </div>
    </dialog>
  </body>
</html>
